<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-diff</title>
    <link rel="icon" href="/ytdiff/assets/favicon.ico">
    <link href="/ytdiff/assets/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="/ytdiff/assets/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/4.5.3/socket.io.min.js"
        integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi"
        crossorigin="anonymous"></script>
    <style>
        .list-table {
            max-height: 80vmin;
            overflow-y: scroll;
            padding-bottom: 15px;
        }
    </style>
</head>

<body>
    <nav class="mt-0 pt-0 mb-0 pb-0 navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="/ytdiff/assets/favicon.ico" alt="" width="30" height="30"
                    class="d-inline-block align-text-top"><span>-diff</span>
            </a>
            <a href="http://localhost:8888/ytdiff/showdb" class="link-warning">See DB</a>
        </div>
    </nav>
    <div class="container">
        <div class="row">
            <div class="col">
                <form class="mb-2">
                    <label for="url" class="form-label">URL: </label>
                    <input type="text" class="form-control" placeholder="url" name="url_input" id="url" />
                    <label for="start" class="form-label">Start: </label>
                    <input type="number" class="form-control" placeholder="1" name="start_input" id="start" />
                    <label for="stop" class="form-label">Stop: </label>
                    <input type="number" class="form-control" placeholder="10" name="stop_input" id="stop" />
                    <!--Removing this wouldn't be such a bad idea, yt-dlp can handle it on it's own,
                        if you are passing an url like this https://www.youtube.com/watch?v=id&list=id
                        and wnat to use the --no-playlist option it's more work than it's worth just pass
                        the url as https://www.youtube.com/watch?v=id -->
                    <!--<label for="is_single" class="form-label">Single video:</label>
                    <input type="checkbox" class="form-check-input" name="is_single" id="is_single">-->
                </form>
                <button id="listit" type="button" onclick="post()" class="btn btn-primary">List</button>
                <div class="btn-group" role="group">
                    <button id="all" type="button" onclick="select_all()" class="btn btn-primary">Select all</button>
                    <button id="none" type="button" onclick="select_none()" class="btn btn-primary">Select none</button>
                </div>
                <button id="dnld" type="button" onclick="download()" class="btn btn-primary">Download
                    Selected</button>
            </div>
            <div class="col">
                <h3>List:</h3>
                <table class="table table-responsive" id="listing">
                    <thead class="list-table">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Title</th>
                        </tr>
                    </thead>
                    <tbody class="list-table">

                    </tbody>
                </table>
                <!--Add the files that will be downloaded here as a list-->
            </div>
        </div>
    </div>
    <script defer>
        window.onload = sockSetup();
        function post() {
            var url = document.getElementById("url").value;
            var start = document.getElementById("start").value;
            var stop = document.getElementById("stop").value;
            const table = document.getElementById("listing");
            console.log("URL: " + url, "Start: " + start, "Stop: " + stop);//, "Single: " + single);
            fetch("/ytdiff/list", {
                method: "post",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },

                //make sure to serialize your JSON body
                body: JSON.stringify({
                    url: url,
                    start: start,
                    stop: stop
                })
            }).then((response) => response.text()).then((text) => {
                response_list = text.slice(0, -2).split("\n").slice(0, -1);
                console.log(response_list, response_list.length)

                response_list.forEach(async element => {
                    var items = element.split("\t");
                    console.log(items, items.length);
                    /*
                        # 	Title 
                    */
                    const row = table.insertRow();
                    const select = row.insertCell(0);
                    const title = row.insertCell(1);


                    let label = document.createElement("label");
                    label.className = "list-group-item";

                    let checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.className = "form-check-input me-1";
                    checkbox.value = "";
                    checkbox.id = items[1];

                    let link = document.createElement('a');
                    link.href = items[2];
                    link.appendChild(document.createTextNode(items[0]));

                    select.appendChild(checkbox);
                    title.appendChild(link);
                    //output.appendChild(label);
                });
            });
        };

        function select_all() {
            document.querySelectorAll('input[type=checkbox]').forEach(element => {
                element.checked = true;
            });
        }

        function select_none() {
            document.querySelectorAll('input[type=checkbox]').forEach(element => {
                element.checked = false;
            });
        }

        function download() {
            var id = []
            document.querySelectorAll('input[type=checkbox]:checked')
                .forEach(element => {
                    id.push(element.id);
                })
            console.log(id);
            fetch("/ytdiff/download", {
                method: "post",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                //make sure to serialize your JSON body
                body: JSON.stringify({
                    ids: id,
                })
            }).then((response) => response.text()).then((text) => {
                console.log(text);
            });
            //set up a websocket to check on the status although it won't be really useful
        }

        function sockSetup() {
            console.log("Sock setup started");
            var socket = io();
            socket.on('init', function (data) {
                console.log(data.message);
                // Respond with a message including this clients' id sent from the server
                socket.emit('acknowledge', { data: 'Connected', id: data.id });
            });
            socket.on('progress', function (data) {
                console.log(data);
            });
            socket.on('error', console.error.bind(console));
            socket.on('done', function (data) {
                console.log(data.message);
                alert('Downloaded: ' + `${data.message}`);
            });
        }
    </script>
</body>

</html>